/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Scala application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/7.4.2/userguide/building_java_projects.html
 */

plugins {
    id "io.gatling.gradle" version "3.7.6.3"
}

def chainLinkHost = System.getenv("CHAIN_LINK_HOST") ?: "localhost"
def chainLinkPort = System.getenv("CHAIN_LINK_PORT") ?: "6688"
def chainLinkHttpProtocol = System.getenv("CHAIN_LINK_HTPP_PROTOCOL") ?: "http"
def chainLinkServerUrl = chainLinkHttpProtocol+'://'+chainLinkHost+':'+chainLinkPort

tasks.addRule('Set variables for the test to run') { String taskName ->
    if(taskName.startsWith('gatlingRun')) {
        System.setProperty("___chainLinkServerURL", chainLinkServerUrl)

        def req = new URL(chainLinkServerUrl+'/sessions').openConnection()
        req.setRequestMethod("POST")
        req.setRequestProperty("Content-Type", "application/json; charset=UTF-8")
        req.setDoOutput(true)
        req.getOutputStream().write(('{"email":"'+System.env.ADMIN_USER+'","password":"'+System.env.ADMIN_PASSWORD+'"}').getBytes())
        System.setProperty("___sessionToken", req.getHeaderField('Set-Cookie'))
    }
}